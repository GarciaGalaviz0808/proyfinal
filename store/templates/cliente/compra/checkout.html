{% extends 'cliente/base.html' %}
{% load static %}
{% load math %}

{% block title %}Checkout - ArtStore{% endblock %}

{% block content %}
<div class="checkout-container">
    <h2>Finalizar Compra</h2>
    
    <div class="checkout-grid">
        <div class="checkout-form">
            <h3>Información de Envío</h3>
            <form method="POST" action="{% url 'checkout' %}">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="direccion">Dirección de Envío *</label>
                    <textarea id="direccion" name="direccion" rows="3" required 
                              placeholder="Calle, número, colonia, ciudad, estado, código postal"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="notas">Notas adicionales (opcional)</label>
                    <textarea id="notas" name="notas" rows="2" 
                              placeholder="Instrucciones especiales para la entrega"></textarea>
                </div>
                
                <h3>Método de Pago</h3>
                <div class="metodos-pago">
                    {% for metodo in metodos_pago %}
                    <div class="metodo-pago">
                        <input type="radio" id="metodo{{ forloop.counter }}" name="metodo_pago" 
                               value="{{ metodo.0 }}" {% if forloop.first %}checked{% endif %} required>
                        <label for="metodo{{ forloop.counter }}">
                            <i class="fas 
                                {% if metodo.0 == 'efectivo' %}fa-money-bill-wave
                                {% elif metodo.0 == 'tarjeta_credito' %}fa-credit-card
                                {% elif metodo.0 == 'tarjeta_debito' %}fa-credit-card
                                {% elif metodo.0 == 'paypal' %}fa-paypal
                                {% endif %}"></i>
                            <span>{{ metodo.1 }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <div id="pago-animacion" class="pago-animacion" style="display: none;">
                    <div class="pago-icono">
                        <i class="fas fa-lock"></i>
                    </div>
                    <p>Procesando pago seguro...</p>
                </div>
                
                <button type="submit" class="btn-comprar btn-large">
                    <i class="fas fa-lock"></i> Realizar Pedido
                </button>
            </form>
        </div>
        
        <div class="checkout-resumen">
            <h3>Resumen del Pedido</h3>
            <div class="resumen-items">
                {% for item in carrito.items.all %}
                <div class="resumen-item">
                    <span>{{ item.producto.nombre }} x {{ item.cantidad }}</span>
                    <span>${{ item.subtotal }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div class="resumen-totales">
                <div class="total-item">
                    <span>Subtotal:</span>
                    <span>${{ carrito.total }}</span>
                </div>
                <div class="total-item">
                    <span>IVA (16%):</span>
                    <span>${{ carrito.total|multiply:0.16|floatformat:2 }}</span>
                </div>
                <div class="total-item total-final">
                    <span>Total a Pagar:</span>
                    <span>${{ carrito.total|multiply:0.16|add:carrito.total|floatformat:2 }}</span>
                </div>
            </div>
            
            <div class="terminos">
                <p><small>Al realizar el pedido, aceptas nuestros <a href="#">Términos y Condiciones</a> y <a href="#">Política de Privacidad</a>.</small></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Animación de pago
document.querySelectorAll('input[name="metodo_pago"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const animacion = document.getElementById('pago-animacion');
        animacion.style.display = 'block';
        
        // Cambiar icono según método
        const icono = animacion.querySelector('.pago-icono i');
        switch(this.value) {
            case 'efectivo':
                icono.className = 'fas fa-money-bill-wave';
                break;
            case 'tarjeta_credito':
            case 'tarjeta_debito':
                icono.className = 'fas fa-credit-card';
                break;
            case 'paypal':
                icono.className = 'fas fa-paypal';
                break;
        }
        
        // Ocultar después de 2 segundos
        setTimeout(() => {
            animacion.style.display = 'none';
        }, 2000);
    });
});

// Validación de formulario
document.querySelector('form').addEventListener('submit', function(e) {
    const direccion = document.getElementById('direccion').value.trim();
    const metodoPago = document.querySelector('input[name="metodo_pago"]:checked');
    
    if (!direccion) {
        e.preventDefault();
        alert('Por favor ingresa la dirección de envío.');
        document.getElementById('direccion').focus();
        return;
    }
    
    if (!metodoPago) {
        e.preventDefault();
        alert('Por favor selecciona un método de pago.');
        return;
    }
    
    // Mostrar confirmación
    if (!confirm('¿Confirmas que deseas realizar este pedido?')) {
        e.preventDefault();
    }
});
</script>
{% endblock %}