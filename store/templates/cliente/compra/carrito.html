{% extends 'cliente/base.html' %}
{% load static %}

{% block title %}Carrito de Compras - ArtStore{% endblock %}

{% block content %}
<div class="carrito-container">
    <h2>Tu Carrito de Compras</h2>
    
    {% if carrito.items.count == 0 %}
    <div class="carrito-vacio">
        <i class="fas fa-shopping-cart fa-3x"></i>
        <h3>Tu carrito está vacío</h3>
        <p>Agrega productos para comenzar tu compra</p>
        <a href="{% url 'index' %}" class="btn-comprar">Seguir Comprando</a>
    </div>
    {% else %}
    <form method="POST" action="{% url 'ver_carrito' %}">
        {% csrf_token %}
        <table class="carrito-tabla">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in carrito.items.all %}
                <tr>
                    <td>
                        <div class="producto-info">
                            {% if item.producto.imagen %}
                            <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" width="80">
                            {% else %}
                            <img src="{% static 'images/placeholder.png' %}" alt="Sin imagen" width="80">
                            {% endif %}
                            <div>
                                <h4>{{ item.producto.nombre }}</h4>
                                <small>{{ item.producto.get_tipo_display }}</small>
                            </div>
                        </div>
                    </td>
                    <td>${{ item.producto.precio|floatformat:2 }}</td>
                    <td>
                        <input type="number" name="cantidad_{{ item.id }}" 
                               value="{{ item.cantidad }}" min="1" max="{{ item.producto.stock }}"
                               class="cantidad-input">
                    </td>
                    <td>${{ item.subtotal|floatformat:2 }}</td>
                    <td>
                        <button type="submit" name="action" value="eliminar" 
                                class="btn-eliminar" onclick="setEliminarItem({{ item.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <input type="hidden" name="item_id" id="item_id">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="carrito-acciones">
            <button type="submit" name="action" value="actualizar" class="btn-actualizar">
                <i class="fas fa-sync-alt"></i> Actualizar Carrito
            </button>
            <a href="{% url 'index' %}" class="btn-seguir">
                <i class="fas fa-arrow-left"></i> Seguir Comprando
            </a>
        </div>
    </form>
    
    <div class="carrito-resumen">
        <h3>Resumen de Compra</h3>
        <div class="resumen-detalles">
            <div class="resumen-item">
                <span>Subtotal:</span>
                <span>${{ subtotal|floatformat:2 }}</span>
            </div>
            <div class="resumen-item">
                <span>IVA (16%):</span>
                <span>${{ iva|floatformat:2 }}</span>
            </div>
            <div class="resumen-item total">
                <span>Total:</span>
                <span>${{ total|floatformat:2 }}</span>
            </div>
        </div>
        <a href="{% url 'checkout' %}" class="btn-proceder">
            Proceder al Pago <i class="fas fa-arrow-right"></i>
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function setEliminarItem(itemId) {
    document.getElementById('item_id').value = itemId;
}

// Actualizar subtotal al cambiar cantidad
document.querySelectorAll('.cantidad-input').forEach(input => {
    input.addEventListener('change', function() {
        const row = this.closest('tr');
        const precioTexto = row.querySelector('td:nth-child(2)').textContent;
        const precio = parseFloat(precioTexto.replace('$', ''));
        const cantidad = parseInt(this.value);
        const subtotalCell = row.querySelector('td:nth-child(4)');
        
        if (!isNaN(precio) && !isNaN(cantidad) && cantidad > 0) {
            subtotalCell.textContent = '$' + (precio * cantidad).toFixed(2);
        }
    });
});

// Validar cantidad máxima
document.querySelectorAll('.cantidad-input').forEach(input => {
    input.addEventListener('input', function() {
        const max = parseInt(this.max);
        const value = parseInt(this.value);
        
        if (value > max) {
            this.value = max;
            alert(`No puedes pedir más de ${max} unidades de este producto.`);
        }
        
        if (value < 1) {
            this.value = 1;
        }
    });
});
</script>
{% endblock %}