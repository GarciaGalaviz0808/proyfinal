{% extends 'cliente/base.html' %}
{% load static %}
{% load math %} 

{% block title %}
    {% if tipo == 'obras' %}Obras Originales
    {% elif tipo == 'replicas' %}Réplicas de Arte
    {% elif tipo == 'oleos' %}Pinturas al Óleo
    {% elif tipo == 'acrilicos' %}Pinturas Acrílicas
    {% elif tipo == 'lienzos' %}Lienzos
    {% elif tipo == 'pinceles' %}Pinceles
    {% elif tipo == 'suministros' %}Suministros de Arte
    {% else %}Productos
    {% endif %} - ArtStore
{% endblock %}

{% block content %}
<div class="productos-container">
    <!-- Encabezado -->
    <div class="productos-header">
        <h2>
            {% if tipo == 'obras' %}
                <i class="fas fa-paint-brush"></i> Obras Originales
            {% elif tipo == 'replicas' %}
                <i class="fas fa-copy"></i> Réplicas de Arte Famoso
            {% elif tipo == 'oleos' %}
                <i class="fas fa-palette"></i> Pinturas al Óleo
            {% elif tipo == 'acrilicos' %}
                <i class="fas fa-fill-drip"></i> Pinturas Acrílicas
            {% elif tipo == 'lienzos' %}
                <i class="fas fa-border-style"></i> Lienzos
            {% elif tipo == 'pinceles' %}
                <i class="fas fa-paint-brush"></i> Pinceles
            {% elif tipo == 'suministros' %}
                <i class="fas fa-box-open"></i> Suministros de Arte
            {% else %}
                <i class="fas fa-box"></i> Productos
            {% endif %}
        </h2>
        
        {% if tipo == 'suministros' %}
        <p class="categoria-descripcion">Encuentra los mejores materiales para tus creaciones artísticas</p>
        {% elif tipo == 'replicas' %}
        <p class="categoria-descripcion">Reproducciones de obras maestras del arte mundial</p>
        {% elif tipo == 'obras' %}
        <p class="categoria-descripcion">Piezas únicas creadas por nuestros talentosos artistas</p>
        {% endif %}
    </div>

    <!-- Filtros -->
    <div class="filtros-container">
        <div class="filtros">
            <div class="filtro-group">
                <label for="ordenar">Ordenar por:</label>
                <select id="ordenar" class="filtro-select">
                    <option value="recientes">Más recientes</option>
                    <option value="precio-asc">Precio: menor a mayor</option>
                    <option value="precio-desc">Precio: mayor a menor</option>
                    <option value="nombre">Nombre A-Z</option>
                    <option value="destacados">Destacados</option>
                </select>
            </div>
            
            <div class="filtro-group">
                <label for="stock">Mostrar:</label>
                <select id="stock" class="filtro-select">
                    <option value="todos">Todos</option>
                    <option value="disponible">Solo disponibles</option>
                    <option value="destacados">Solo destacados</option>
                </select>
            </div>
        </div>
        
        <div class="contador-productos">
            <span id="contador">{{ productos|length }}</span> productos encontrados
        </div>
    </div>

    <!-- Lista de productos -->
    {% if productos %}
    <section class="galeria-productos">
        {% for producto in productos %}
        <div class="producto-card" data-stock="{{ producto.stock }}" data-destacado="{{ producto.destacado|yesno:'true,false' }}">
            <!-- Imagen del producto -->
            <div class="producto-imagen">
                <a href="{% url 'detalle_producto' producto.id %}">
                    {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" loading="lazy">
                    {% else %}
                    <div class="producto-sin-imagen">
                        <i class="fas fa-image"></i>
                        <span>Imagen no disponible</span>
                    </div>
                    {% endif %}
                </a>
                
                <!-- Badges -->
                {% if producto.destacado %}
                <div class="producto-badge destacado">
                    <i class="fas fa-star"></i> Destacado
                </div>
                {% endif %}
                
                {% if producto.stock <= 5 and producto.stock > 0 %}
                <div class="producto-badge stock-bajo">
                    <i class="fas fa-exclamation-triangle"></i> Poco stock
                </div>
                {% elif producto.stock == 0 %}
                <div class="producto-badge agotado">
                    <i class="fas fa-times-circle"></i> Agotado
                </div>
                {% endif %}
            </div>

            <!-- Información del producto -->
            <div class="producto-info">
                <h3 class="producto-nombre">
                    <a href="{% url 'detalle_producto' producto.id %}">{{ producto.nombre }}</a>
                </h3>
                
                {% if producto.artista %}
                <p class="producto-artista">
                    <i class="fas fa-user"></i> {{ producto.artista.nombre }}
                </p>
                {% endif %}
                
                <p class="producto-descripcion">
                    {{ producto.descripcion|truncatechars:100 }}
                </p>
                
                <div class="producto-detalles">
                    <span class="producto-tipo">
                        <i class="fas fa-tag"></i> {{ producto.get_tipo_display }}
                    </span>
                    
                    {% if producto.categoria %}
                    <span class="producto-categoria">
                        <i class="fas fa-folder"></i> {{ producto.categoria.nombre }}
                    </span>
                    {% endif %}
                </div>
                
                <div class="producto-precio-stock">
                    <div class="producto-precio">
                        <span class="precio">${{ producto.precio }}</span>
                        <small class="iva">+ IVA 16%</small>
                    </div>
                    
                    <div class="producto-stock">
                        {% if producto.stock > 0 %}
                        <span class="stock-disponible">
                            <i class="fas fa-check-circle"></i> 
                            {{ producto.stock }} disponibles
                        </span>
                        {% else %}
                        <span class="stock-agotado">
                            <i class="fas fa-times-circle"></i> Agotado
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="producto-acciones">
                    <a href="{% url 'detalle_producto' producto.id %}" class="btn-ver-detalle">
                        <i class="fas fa-eye"></i> Ver detalles
                    </a>
                    
                    {% if producto.stock > 0 %}
                        {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'agregar_al_carrito' producto.id %}" class="form-agregar-carrito">
                            {% csrf_token %}
                            <input type="hidden" name="cantidad" value="1">
                            <button type="submit" class="btn-agregar-carrito">
                                <i class="fas fa-cart-plus"></i> Añadir
                            </button>
                        </form>
                        {% else %}
                        <a href="{% url 'login' %}?next={% url 'detalle_producto' producto.id %}" class="btn-agregar-carrito">
                            <i class="fas fa-cart-plus"></i> Añadir
                        </a>
                        {% endif %}
                    {% else %}
                    <button class="btn-agregar-carrito disabled" disabled>
                        <i class="fas fa-ban"></i> Agotado
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </section>
    
    <!-- Mensaje si no hay productos -->
    {% else %}
    <div class="no-productos">
        <div class="no-productos-icon">
            <i class="fas fa-palette fa-4x"></i>
        </div>
        <h3>No hay productos disponibles</h3>
        <p>Actualmente no tenemos productos en esta categoría.</p>
        <a href="{% url 'index' %}" class="btn-volver-inicio">
            <i class="fas fa-arrow-left"></i> Volver al inicio
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Filtros de productos
document.addEventListener('DOMContentLoaded', function() {
    const productos = document.querySelectorAll('.producto-card');
    const contador = document.getElementById('contador');
    
    // Filtro por orden
    document.getElementById('ordenar').addEventListener('change', function() {
        const valor = this.value;
        const productosArray = Array.from(productos);
        
        productosArray.sort((a, b) => {
            const precioA = parseFloat(a.querySelector('.precio').textContent.replace('$', ''));
            const precioB = parseFloat(b.querySelector('.precio').textContent.replace('$', ''));
            const nombreA = a.querySelector('.producto-nombre').textContent.toLowerCase();
            const nombreB = b.querySelector('.producto-nombre').textContent.toLowerCase();
            
            switch(valor) {
                case 'precio-asc':
                    return precioA - precioB;
                case 'precio-desc':
                    return precioB - precioA;
                case 'nombre':
                    return nombreA.localeCompare(nombreB);
                case 'destacados':
                    const destacadoA = a.dataset.destacado === 'true';
                    const destacadoB = b.dataset.destacado === 'true';
                    return destacadoB - destacadoA;
                default:
                    return 0;
            }
        });
        
        // Reordenar en el DOM
        const galeria = document.querySelector('.galeria-productos');
        productosArray.forEach(producto => galeria.appendChild(producto));
    });
    
    // Filtro por disponibilidad
    document.getElementById('stock').addEventListener('change', function() {
        const valor = this.value;
        let visibles = 0;
        
        productos.forEach(producto => {
            const stock = parseInt(producto.dataset.stock);
            const destacado = producto.dataset.destacado === 'true';
            let mostrar = true;
            
            if (valor === 'disponible' && stock === 0) {
                mostrar = false;
            } else if (valor === 'destacados' && !destacado) {
                mostrar = false;
            }
            
            producto.style.display = mostrar ? '' : 'none';
            if (mostrar) visibles++;
        });
        
        contador.textContent = visibles;
    });
    
    // Efecto hover en tarjetas
    productos.forEach(producto => {
        producto.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 10px 20px rgba(0,0,0,0.15)';
        });
        
        producto.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)';
        });
    });
    
    // Agregar al carrito con feedback
    document.querySelectorAll('.form-agregar-carrito').forEach(form => {
        form.addEventListener('submit', function(e) {
            const button = this.querySelector('button');
            const originalText = button.innerHTML;
            
            // Mostrar feedback
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Restaurar después de 2 segundos
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        });
    });
});
</script>
{% endblock %}