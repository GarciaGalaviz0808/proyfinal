{% extends 'admin/base_admin.html' %}

{% block title %}{{ titulo }} - ArtStore Admin{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'crud_lista' modelo %}">{{ titulo_formateado|default:titulo }}</a></li>
<li class="active">Lista</li>
{% endblock %}

{% block content %}
<div class="crud-container">
    <div class="crud-header">
        <h2><i class="fas fa-list"></i> {{ titulo_formateado|default:titulo }}</h2>
        
        <div class="crud-actions">
            {% if modelo != 'usuarios' and modelo != 'pedidos' %}
            <a href="{% url 'crud_crear' modelo %}" class="btn-add">
                <i class="fas fa-plus"></i> Agregar Nuevo
            </a>
            {% endif %}
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar...">
                <button type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            {% if modelo == 'pedidos' %}
            <div class="filter-dropdown">
                <select id="filterStatus">
                    <option value="">Todos los estados</option>
                    {% for estado in estado_choices %}
                    <option value="{{ estado.0 }}">{{ estado.1 }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            {% if modelo == 'usuarios' %}
            <div class="filter-dropdown">
                <select id="filterType" onchange="filterUsers(this.value)">
                    <option value="">Todos los usuarios</option>
                    <option value="clientes">Clientes</option>
                    <option value="staff">Staff</option>
                    <option value="superuser">Superusuarios</option>
                </select>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Estadísticas de la Lista -->
    <div class="list-stats">
        <div class="stat-item">
            <span class="stat-label">Total:</span>
            <span class="stat-value">{{ objetos.paginator.count }}</span>
        </div>
        
        {% if modelo == 'productos' and stats.activos is not None %}
        <div class="stat-item">
            <span class="stat-label">Activos:</span>
            <span class="stat-value">{{ stats.activos }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Destacados:</span>
            <span class="stat-value">{{ stats.destacados }}</span>
        </div>
        {% endif %}
        
        {% if modelo == 'pedidos' and stats.pendientes is not None %}
        <div class="stat-item">
            <span class="stat-label">Pendientes:</span>
            <span class="stat-value">{{ stats.pendientes }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total Ventas:</span>
            <span class="stat-value">${{ total_ventas|default:"0" }}</span>
        </div>
        {% endif %}
        
        {% if modelo == 'usuarios' and stats is not None %}
        <div class="stat-item">
            <span class="stat-label">Staff:</span>
            <span class="stat-value">{{ stats.staff }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Clientes:</span>
            <span class="stat-value">{{ stats.clientes }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Superusers:</span>
            <span class="stat-value">{{ stats.superusers }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Tabla de Datos -->
    <div class="table-responsive">
        <table class="crud-table" id="dataTable">
            <thead>
                <tr>
                    {% if modelo == 'productos' %}
                    <th>ID</th>
                    <th>Imagen</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                    
                    {% elif modelo == 'artistas' %}
                    <th>ID</th>
                    <th>Foto</th>
                    <th>Nombre</th>
                    <th>Especialidad</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                    
                    {% elif modelo == 'categorias' %}
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Slug</th>
                    <th>Productos</th>
                    <th>Acciones</th>
                    
                    {% elif modelo == 'pedidos' %}
                    <th>N° Pedido</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Método Pago</th>
                    <th>Acciones</th>
                    
                    {% elif modelo == 'encargos' %}
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Tipo Obra</th>
                    <th>Estado</th>
                    <th>Fecha Solicitud</th>
                    <th>Acciones</th>
                    
                    {% elif modelo == 'usuarios' %}
                    <th>ID</th>
                    <th>Avatar</th>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Último Acceso</th>
                    <th>Acciones</th>
                    
                    {% else %}
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for objeto in objetos %}
                <tr>
                    {% if modelo == 'productos' %}
                    <td>{{ objeto.id }}</td>
                    <td>
                        {% if objeto.imagen %}
                        <img src="{{ objeto.imagen.url }}" alt="{{ objeto.nombre }}" class="table-img">
                        {% else %}
                        <div class="no-img">
                            <i class="fas fa-image"></i>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ objeto.nombre|truncatechars:30 }}</strong>
                        {% if objeto.descripcion %}
                        <small class="text-muted">{{ objeto.descripcion|truncatechars:50 }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-category">{{ objeto.get_tipo_display|default:objeto.tipo }}</span>
                    </td>
                    <td>${{ objeto.precio }}</td>
                    <td>
                        {% if objeto.stock < 5 %}
                        <span class="stock-badge badge-danger">{{ objeto.stock }}</span>
                        {% elif objeto.stock < 10 %}
                        <span class="stock-badge badge-warning">{{ objeto.stock }}</span>
                        {% else %}
                        <span class="stock-badge badge-success">{{ objeto.stock }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if objeto.activo %}
                        <span class="status-badge status-activo">Activo</span>
                        {% else %}
                        <span class="status-badge status-inactivo">Inactivo</span>
                        {% endif %}
                        {% if objeto.destacado %}
                        <span class="badge badge-highlight"><i class="fas fa-star"></i> Destacado</span>
                        {% endif %}
                    </td>
                    
                    {% elif modelo == 'artistas' %}
                    <td>{{ objeto.id }}</td>
                    <td>
                        {% if objeto.foto %}
                        <img src="{{ objeto.foto.url }}" alt="{{ objeto.nombre }}" class="table-img">
                        {% else %}
                        <div class="no-img">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ objeto.nombre|truncatechars:30 }}</strong>
                        {% if objeto.especialidad %}
                        <small class="text-muted">{{ objeto.especialidad|truncatechars:30 }}</small>
                        {% endif %}
                    </td>
                    <td>{{ objeto.especialidad|truncatechars:30 }}</td>
                    <td>
                        {% if objeto.activo %}
                        <span class="status-badge status-activo">Activo</span>
                        {% else %}
                        <span class="status-badge status-inactivo">Inactivo</span>
                        {% endif %}
                    </td>
                    
                    {% elif modelo == 'categorias' %}
                    <td>{{ objeto.id }}</td>
                    <td>
                        <strong>{{ objeto.nombre|truncatechars:30 }}</strong>
                    </td>
                    <td>
                        <code>{{ objeto.slug|truncatechars:20 }}</code>
                    </td>
                    <td>
                        {% with count=objeto.producto_set.count %}
                        <span class="badge badge-info">{{ count }}</span>
                        {% endwith %}
                    </td>
                    
                    {% elif modelo == 'pedidos' %}
                    <td>
                        <strong>#{{ objeto.numero_pedido|default:objeto.id }}</strong>
                    </td>
                    <td>
                        {% with usuario=objeto.usuario %}
                        {{ usuario.get_full_name|default:usuario.username|truncatechars:20 }}
                        <small class="text-muted">{{ usuario.email|truncatechars:20 }}</small>
                        {% endwith %}
                    </td>
                    <td>{{ objeto.fecha_pedido|date:"d/m/Y H:i" }}</td>
                    <td>
                        <strong>${{ objeto.total }}</strong>
                    </td>
                    <td>
                        <span class="status-badge status-{{ objeto.estado }}">
                            {{ objeto.get_estado_display|default:objeto.estado }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-payment">
                            {{ objeto.get_metodo_pago_display|default:objeto.metodo_pago }}
                        </span>
                    </td>
                    
                    {% elif modelo == 'encargos' %}
                    <td>{{ objeto.id }}</td>
                    <td>
                        {% with cliente=objeto.cliente %}
                        {{ cliente.get_full_name|default:cliente.username|truncatechars:20 }}
                        <small class="text-muted">{{ cliente.email|truncatechars:20 }}</small>
                        {% endwith %}
                    </td>
                    <td>
                        <span class="badge badge-encargo">{{ objeto.get_tipo_obra_display|default:objeto.tipo_obra }}</span>
                    </td>
                    <td>
                        <span class="status-badge status-{{ objeto.estado }}">
                            {{ objeto.get_estado_display|default:objeto.estado }}
                        </span>
                    </td>
                    <td>{{ objeto.fecha_solicitud|date:"d/m/Y" }}</td>
                    
                    {% elif modelo == 'usuarios' %}
                    <td>{{ objeto.id }}</td>
                    <td>
                        <div class="user-avatar">
                            <div class="no-avatar">
                                <i class="fas fa-user-circle"></i>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>{{ objeto.username|truncatechars:20 }}</strong>
                        <small class="text-muted">Registro: {{ objeto.date_joined|date:"d/m/Y" }}</small>
                    </td>
                    <td>
                        {{ objeto.get_full_name|default:"Sin nombre" }}
                    </td>
                    <td>{{ objeto.email|truncatechars:25 }}</td>
                    <td>
                        {% if objeto.is_superuser %}
                        <span class="badge badge-danger">Super Admin</span>
                        {% elif objeto.is_staff %}
                        <span class="badge badge-warning">Staff</span>
                        {% else %}
                        <span class="badge badge-info">Cliente</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if objeto.is_active %}
                        <span class="status-badge status-activo">Activo</span>
                        {% else %}
                        <span class="status-badge status-inactivo">Inactivo</span>
                        {% endif %}
                    </td>
                    <td>{{ objeto.last_login|date:"d/m/Y H:i"|default:"Nunca" }}</td>
                    
                    {% else %}
                    <td>{{ objeto.id }}</td>
                    <td>{{ objeto.nombre|default:objeto.username|truncatechars:30 }}</td>
                    {% endif %}
                    
                    <td>
                        <a href="{% url 'crud_detalle' modelo objeto.id %}" class="btn-action btn-view" title="Ver">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'crud_editar' modelo objeto.id %}" class="btn-action btn-edit" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'crud_eliminar' modelo objeto.id %}" class="btn-action btn-delete" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center empty-table">
                        <i class="fas fa-inbox fa-3x"></i>
                        <h4>No hay registros</h4>
                        <p>No se encontraron {{ titulo_formateado|default:titulo|lower }} en el sistema.</p>
                        {% if modelo != 'usuarios' and modelo != 'pedidos' %}
                        <a href="{% url 'crud_crear' modelo %}" class="btn-add">
                            <i class="fas fa-plus"></i> Agregar el primero
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    {% if objetos.has_other_pages %}
    <div class="pagination">
        <div class="pagination-info">
            Mostrando {{ objetos.start_index }} - {{ objetos.end_index }} de {{ objetos.paginator.count }}
        </div>
        
        <div class="pagination-controls">
            {% if objetos.has_previous %}
            <a href="?page=1{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="page-link first">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ objetos.previous_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="page-link prev">
                <i class="fas fa-angle-left"></i>
            </a>
            {% endif %}
            
            {% for num in objetos.paginator.page_range %}
                {% if objetos.number == num %}
                <span class="page-link current">{{ num }}</span>
                {% elif num > objetos.number|add:'-3' and num < objetos.number|add:'3' %}
                <a href="?page={{ num }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if objetos.has_next %}
            <a href="?page={{ objetos.next_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="page-link next">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ objetos.paginator.num_pages }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}" class="page-link last">
                <i class="fas fa-angle-double-right"></i>
            </a>
            {% endif %}
        </div>
        
        <div class="pagination-size">
            <select id="pageSize">
                <option value="10" {% if request.GET.page_size == "10" %}selected{% endif %}>10 por página</option>
                <option value="25" {% if request.GET.page_size == "25" %}selected{% endif %}>25 por página</option>
                <option value="50" {% if request.GET.page_size == "50" %}selected{% endif %}>50 por página</option>
                <option value="100" {% if request.GET.page_size == "100" %}selected{% endif %}>100 por página</option>
            </select>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Búsqueda en tiempo real
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#dataTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Filtro por estado (para pedidos)
{% if modelo == 'pedidos' %}
document.getElementById('filterStatus').addEventListener('change', function() {
    const status = this.value;
    const rows = document.querySelectorAll('#dataTable tbody tr');
    
    rows.forEach(row => {
        if (!status) {
            row.style.display = '';
            return;
        }
        
        const statusCell = row.querySelector('.status-badge');
        if (statusCell && statusCell.classList.contains(`status-${status}`)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});
{% endif %}

// Filtro por tipo de usuario
{% if modelo == 'usuarios' %}
function filterUsers(type) {
    window.location.href = `?type=${type}`;
}

document.getElementById('filterType').value = '{{ request.GET.type|default:"" }}';
{% endif %}

// Cambiar tamaño de página
document.getElementById('pageSize').addEventListener('change', function() {
    const size = this.value;
    const url = new URL(window.location);
    url.searchParams.set('page_size', size);
    window.location.href = url.toString();
});

// Ordenar tabla
document.querySelectorAll('.crud-table th').forEach((th, index) => {
    th.addEventListener('click', function() {
        const table = this.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        const isAscending = this.classList.contains('asc');
        this.classList.toggle('asc', !isAscending);
        this.classList.toggle('desc', isAscending);
        
        rows.sort((a, b) => {
            const aText = a.cells[index].textContent.trim();
            const bText = b.cells[index].textContent.trim();
            
            // Intentar convertir a número si es posible
            const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
            const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return isAscending ? aNum - bNum : bNum - aNum;
            }
            
            return isAscending 
                ? aText.localeCompare(bText)
                : bText.localeCompare(aText);
        });
        
        // Reinsertar filas ordenadas
        rows.forEach(row => tbody.appendChild(row));
    });
});
</script>
{% endblock %}