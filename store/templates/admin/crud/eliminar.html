{% extends 'admin/base_admin.html' %}

{% block title %}Eliminar {{ titulo }} - ArtStore Admin{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'crud_lista' modelo %}">{{ modelo|capfirst }}</a></li>
<li><a href="{% url 'crud_detalle' modelo objeto.id %}">Detalle</a></li>
<li class="active">Eliminar</li>
{% endblock %}

{% block content %}
<div class="delete-container">
    <div class="delete-warning">
        <div class="warning-icon">
            <i class="fas fa-exclamation-triangle fa-4x"></i>
        </div>
        
        <h2><i class="fas fa-trash"></i> Confirmar Eliminación</h2>
        <p class="warning-text">¿Estás seguro de que deseas eliminar este registro?</p>
        
        <div class="delete-info">
            <div class="info-card">
                <h4>Registro a Eliminar</h4>
                <div class="info-content">
                    {% if modelo == 'productos' %}
                    <div class="info-image">
                        {% if objeto.imagen %}
                        <img src="{{ objeto.imagen.url }}" alt="{{ objeto.nombre }}">
                        {% else %}
                        <div class="no-image">
                            <i class="fas fa-image"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="info-details">
                        <h5>{{ objeto.nombre }}</h5>
                        <p><strong>Tipo:</strong> {{ objeto.get_tipo_display }}</p>
                        <p><strong>Precio:</strong> ${{ objeto.precio }}</p>
                        <p><strong>Stock:</strong> {{ objeto.stock }} unidades</p>
                        <p><strong>ID:</strong> {{ objeto.id }}</p>
                    </div>
                    
                    {% elif modelo == 'artistas' %}
                    <div class="info-image">
                        {% if objeto.foto %}
                        <img src="{{ objeto.foto.url }}" alt="{{ objeto.nombre }}">
                        {% else %}
                        <div class="no-image">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        {% endif %}
                    </div>
                    {% elif modelo == 'usuarios' %}
                    <div class="info-details">
                        <h5>{{ objeto.username }}</h5>
                        <p><strong>Nombre:</strong> {{ objeto.get_full_name|default:"No especificado" }}</p>
                        <p><strong>Email:</strong> {{ objeto.email }}</p>
                        <p><strong>Tipo:</strong> 
                            {% if objeto.is_superuser %}
                            <span class="badge badge-danger">Super Admin</span>
                            {% elif objeto.is_staff %}
                            <span class="badge badge-warning">Staff</span>
                            {% else %}
                            <span class="badge badge-info">Cliente</span>
                            {% endif %}
                        </p>
                        <p><strong>Estado:</strong> 
                            <span class="status-badge status-{% if objeto.is_active %}activo{% else %}inactivo{% endif %}">
                                {% if objeto.is_active %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </p>
                        <p><strong>Registro:</strong> {{ objeto.date_joined|date:"d/m/Y" }}</p>
                        <p><strong>Último acceso:</strong> {{ objeto.last_login|date:"d/m/Y H:i"|default:"Nunca" }}</p>
                    </div>
                    <div class="info-details">
                        <h5>{{ objeto.nombre }}</h5>
                        <p><strong>Especialidad:</strong> {{ objeto.especialidad }}</p>
                        <p><strong>Usuario:</strong> {{ objeto.usuario.username }}</p>
                        <p><strong>ID:</strong> {{ objeto.id }}</p>
                    </div>
                    
                    {% elif modelo == 'pedidos' %}
                    <div class="info-details">
                        <h5>Pedido #{{ objeto.numero_pedido }}</h5>
                        <p><strong>Cliente:</strong> {{ objeto.usuario.get_full_name|default:objeto.usuario.username }}</p>
                        <p><strong>Fecha:</strong> {{ objeto.fecha_pedido|date:"d/m/Y H:i" }}</p>
                        <p><strong>Total:</strong> ${{ objeto.total }}</p>
                        <p><strong>Estado:</strong> <span class="status-badge status-{{ objeto.estado }}">{{ objeto.get_estado_display }}</span></p>
                        <p><strong>ID:</strong> {{ objeto.id }}</p>
                    </div>
                    
                    {% elif modelo == 'encargos' %}
                    <div class="info-details">
                        <h5>Encargo #{{ objeto.id }}</h5>
                        <p><strong>Cliente:</strong> {{ objeto.cliente.get_full_name|default:objeto.cliente.username }}</p>
                        <p><strong>Tipo:</strong> {{ objeto.get_tipo_obra_display }}</p>
                        <p><strong>Estado:</strong> <span class="status-badge status-{{ objeto.estado }}">{{ objeto.get_estado_display }}</span></p>
                        <p><strong>Fecha Solicitud:</strong> {{ objeto.fecha_solicitud|date:"d/m/Y" }}</p>
                        <p><strong>ID:</strong> {{ objeto.id }}</p>
                    </div>
                    
                    {% else %}
                    <div class="info-details">
                        <h5>{{ objeto.nombre|default:objeto }}</h5>
                        <p><strong>ID:</strong> {{ objeto.id }}</p>
                        <p><strong>Tipo:</strong> {{ modelo|capfirst }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Consecuencias de la eliminación -->
        <div class="consequences-warning">
            <h4><i class="fas fa-exclamation-circle"></i> Consecuencias de esta acción:</h4>
            <ul>
                {% if modelo == 'productos' %}
                <li><i class="fas fa-times-circle"></i> El producto será removido del catálogo</li>
                <li><i class="fas fa-times-circle"></i> No podrá ser agregado a nuevos carritos</li>
                <li><i class="fas fa-times-circle"></i> Los pedidos existentes mantendrán la información</li>
                <li><i class="fas fa-times-circle"></i> No se podrá recuperar la información</li>
                
                {% elif modelo == 'artistas' %}
                <li><i class="fas fa-times-circle"></i> El artista será removido del sistema</li>
                <li><i class="fas fa-times-circle"></i> Sus productos asociados perderán la referencia</li>
                <li><i class="fas fa-times-circle"></i> Los encargos asignados quedarán sin artista</li>
                
                {% elif modelo == 'pedidos' %}
                <li><i class="fas fa-times-circle"></i> El pedido será eliminado permanentemente</li>
                <li><i class="fas fa-times-circle"></i> No se podrá generar factura nuevamente</li>
                <li><i class="fas fa-times-circle"></i> Se perderá el historial de ventas</li>
                
                {% elif modelo == 'encargos' %}
                <li><i class="fas fa-times-circle"></i> El encargo será eliminado permanentemente</li>
                <li><i class="fas fa-times-circle"></i> Se perderá la comunicación con el cliente</li>
                <li><i class="fas fa-times-circle"></i> No se podrá recuperar la información</li>
                
                {% else %}
                <li><i class="fas fa-times-circle"></i> El registro será eliminado permanentemente</li>
                <li><i class="fas fa-times-circle"></i> No se podrá recuperar la información</li>
                {% endif %}
            </ul>
            
            {% if dependencies %}
            <div class="dependencies-warning">
                <h5><i class="fas fa-link"></i> Dependencias encontradas:</h5>
                <ul>
                    {% for dep in dependencies %}
                    <li>{{ dep }}</li>
                    {% endfor %}
                </ul>
                <p class="warning-note">¡Eliminar este registro también eliminará las dependencias!</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Opciones de eliminación -->
        <div class="delete-options">
            <div class="option-card">
                <h5><i class="fas fa-archive"></i> ¿Considerar archivar en lugar de eliminar?</h5>
                <p>Archivar mantiene el registro en la base de datos pero lo oculta del sistema.</p>
                {% if modelo in archive_models %}
                <button class="btn-archive" onclick="archiveInstead()">
                    <i class="fas fa-archive"></i> Archivar en lugar de Eliminar
                </button>
                {% endif %}
            </div>
            
            <div class="option-card">
                <h5><i class="fas fa-download"></i> ¿Exportar datos antes de eliminar?</h5>
                <p>Guarda una copia de seguridad de toda la información antes de proceder.</p>
                <button class="btn-export" onclick="exportBeforeDelete()">
                    <i class="fas fa-file-export"></i> Exportar Datos
                </button>
            </div>
        </div>
        
        <!-- Confirmación final -->
        <div class="final-confirmation">
            <div class="confirmation-check">
                <input type="checkbox" id="confirmDelete" name="confirmDelete">
                <label for="confirmDelete">
                    <strong>Confirmo que comprendo las consecuencias y deseo proceder con la eliminación.</strong>
                </label>
            </div>
            
            <div class="confirmation-input">
                <label for="typeConfirm">Para confirmar, escribe "ELIMINAR" a continuación:</label>
                <input type="text" id="typeConfirm" placeholder="Escribe ELIMINAR aquí...">
                <small class="hint">Debes escribir exactamente "ELIMINAR" en mayúsculas</small>
            </div>
        </div>
        
        <!-- Acciones -->
        <div class="delete-actions">
            <form method="POST" action="{% url 'crud_eliminar' modelo objeto.id %}" id="deleteForm">
                {% csrf_token %}
                <a href="{% url 'crud_detalle' modelo objeto.id %}" class="btn-cancel">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="button" class="btn-delete" onclick="validateAndSubmit()" disabled>
                    <i class="fas fa-trash"></i> Eliminar Permanentemente
                </button>
            </form>
        </div>
        
        <!-- Información de seguridad -->
        <div class="security-info">
            <p><i class="fas fa-shield-alt"></i> <strong>Información de Seguridad:</strong></p>
            <ul>
                <li>Esta acción es irreversible</li>
                <li>Se registrará en el historial del sistema</li>
                <li>Se notificará al administrador principal</li>
                <li>Los datos eliminados no podrán recuperarse</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CONFIRMATION_TEXT = 'ELIMINAR';
let canDelete = false;

// Validar confirmación en tiempo real
document.getElementById('typeConfirm').addEventListener('input', function() {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteBtn = document.querySelector('.btn-delete');
    
    const isTextCorrect = this.value === CONFIRMATION_TEXT;
    const isChecked = confirmCheckbox.checked;
    
    canDelete = isTextCorrect && isChecked;
    deleteBtn.disabled = !canDelete;
    
    // Cambiar color del input
    if (this.value === '') {
        this.style.borderColor = '#ccc';
    } else if (isTextCorrect) {
        this.style.borderColor = '#4CAF50';
        this.style.backgroundColor = '#f0f9f0';
    } else {
        this.style.borderColor = '#f44336';
        this.style.backgroundColor = '#fef0f0';
    }
});

// Validar checkbox
document.getElementById('confirmDelete').addEventListener('change', function() {
    const typeConfirm = document.getElementById('typeConfirm');
    const deleteBtn = document.querySelector('.btn-delete');
    
    const isTextCorrect = typeConfirm.value === CONFIRMATION_TEXT;
    const isChecked = this.checked;
    
    canDelete = isTextCorrect && isChecked;
    deleteBtn.disabled = !canDelete;
});

// Validar y enviar formulario
function validateAndSubmit() {
    if (!canDelete) {
        alert('Por favor completa la confirmación correctamente.');
        return;
    }
    
    if (!confirm('¿ESTÁS ABSOLUTAMENTE SEGURO? Esta acción NO se puede deshacer.')) {
        return;
    }
    
    // Mostrar animación de eliminación
    const deleteBtn = document.querySelector('.btn-delete');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
    deleteBtn.disabled = true;
    
    // Contador regresivo
    let countdown = 5;
    const countdownInterval = setInterval(() => {
        if (countdown > 0) {
            deleteBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Eliminando en ${countdown}...`;
            countdown--;
        } else {
            clearInterval(countdownInterval);
            document.getElementById('deleteForm').submit();
        }
    }, 1000);
}

// Archivar en lugar de eliminar
function archiveInstead() {
    if (confirm('¿Archivar este registro en lugar de eliminarlo?')) {
        fetch(`/api/${'{{ modelo }}'}/${'{{ objeto.id }}'}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            }
        });
    }
}

// Exportar antes de eliminar
function exportBeforeDelete() {
    const format = prompt('Formato de exportación (JSON, CSV, Excel):', 'JSON');
    if (format) {
        alert(`Exportando datos en formato ${format}...`);
        // En implementación real, aquí se haría la exportación
        fetch(`/api/${'{{ modelo }}'}/${'{{ objeto.id }}'}/export/?format=${format}`)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${'{{ modelo }}'}_${'{{ objeto.id }}'}_${new Date().toISOString().split('T')[0]}.${format.toLowerCase()}`;
                a.click();
                window.URL.revokeObjectURL(url);
            });
    }
}

// Prevenir navegación accidental
window.addEventListener('beforeunload', function(e) {
    if (document.getElementById('typeConfirm').value || document.getElementById('confirmDelete').checked) {
        e.preventDefault();
        e.returnValue = 'Tienes cambios sin guardar en la confirmación de eliminación. ¿Seguro que quieres salir?';
    }
});

// Animar icono de advertencia
const warningIcon = document.querySelector('.warning-icon i');
setInterval(() => {
    warningIcon.style.transform = 'scale(1.1)';
    warningIcon.style.color = '#f44336';
    setTimeout(() => {
        warningIcon.style.transform = 'scale(1)';
        warningIcon.style.color = '#ff9800';
    }, 500);
}, 2000);
</script>
{% endblock %}